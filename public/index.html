<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warlock - Server Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Rajdhani', 'Inter', sans-serif;
            background: 
                radial-gradient(circle at 20% 80%, rgba(0, 150, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 150, 255, 0.2) 0%, transparent 50%),
                linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: #e2e8f0;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 100px,
                    rgba(0, 150, 255, 0.03) 101px,
                    rgba(0, 150, 255, 0.03) 102px
                ),
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 100px,
                    rgba(0, 150, 255, 0.03) 101px,
                    rgba(0, 150, 255, 0.03) 102px
                );
            pointer-events: none;
            z-index: 1;
        }
        
        .header {
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(15px);
            padding: 1.2rem 0;
            box-shadow: 
                0 2px 20px rgba(0, 150, 255, 0.2),
                inset 0 1px 0 rgba(0, 150, 255, 0.15);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(0, 150, 255, 0.3);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }
        
        .logo {
            font-size: 2rem;
            font-weight: 700;
            color: #0096ff;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-family: 'Orbitron', monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 0 10px rgba(0, 150, 255, 0.5);
        }

        .logo i {
            font-size: 1.8rem;
            animation: rotate 15s linear infinite;
            color: #0096ff;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .nav-menu {
            display: flex;
            gap: 3rem;
            list-style: none;
        }
        
        .nav-menu a {
            text-decoration: none;
            color: #87ceeb;
            font-weight: 600;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.4s ease;
            position: relative;
            padding: 0.5rem 1rem;
            border-radius: 8px;
        }

        .nav-menu a::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(0, 212, 255, 0.2), transparent);
            opacity: 0;
            transition: opacity 0.4s ease;
            border-radius: 8px;
        }
        
        .nav-menu a:hover::before,
        .nav-menu a.active::before {
            opacity: 1;
        }
        
        .nav-menu a:hover,
        .nav-menu a.active {
            color: #00d4ff;
            text-shadow: 0 0 15px #00d4ff;
            border: 1px solid rgba(0, 212, 255, 0.4);
        }
        
        .nav-menu a.active::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00d4ff, transparent);
            box-shadow: 0 0 10px #00d4ff;
        }
        
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 3rem;
            position: relative;
            z-index: 2;
        }
        
        .sidebar {
            background: rgba(26, 26, 46, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 150, 255, 0.2);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(0, 150, 255, 0.2),
                0 0 30px rgba(0, 150, 255, 0.1);
            height: fit-content;
            position: sticky;
            top: 100px;
            overflow: hidden;
        }
        
        .sidebar h3 {
            color: #0096ff;
            margin-bottom: 1.5rem;
            font-size: 1.2rem;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-shadow: 0 0 8px rgba(0, 150, 255, 0.3);
        }

        .sidebar h3 i {
            font-size: 1.1rem;
            text-shadow: 0 0 10px rgba(0, 150, 255, 0.4);
        }
        
        .command-list {
            list-style: none;
        }
        
        .command-item {
            padding: 1rem 1.25rem;
            margin-bottom: 0.75rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.4s ease;
            border: 1px solid rgba(0, 212, 255, 0.2);
            background: rgba(0, 40, 80, 0.3);
            display: flex;
            align-items: center;
            gap: 1rem;
            position: relative;
            overflow: hidden;
        }

        .command-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .command-item:hover {
            background: rgba(0, 212, 255, 0.15);
            border-color: #00d4ff;
            box-shadow: 
                0 0 20px rgba(0, 212, 255, 0.3),
                inset 0 0 20px rgba(0, 212, 255, 0.1);
            transform: translateX(5px);
        }

        .command-item:hover::before {
            left: 100%;
        }
        
        .command-item.active {
            background: rgba(0, 212, 255, 0.25);
            border-color: #00d4ff;
            color: #00d4ff;
            font-weight: 600;
            box-shadow: 
                0 0 25px rgba(0, 212, 255, 0.5),
                inset 0 0 25px rgba(0, 212, 255, 0.2);
            text-shadow: 0 0 10px #00d4ff;
        }
        
        .command-icon {
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
            color: #87ceeb;
            text-shadow: 0 0 8px currentColor;
        }

        .command-item:hover .command-icon,
        .command-item.active .command-icon {
            color: #00d4ff;
            text-shadow: 0 0 12px #00d4ff;
        }
        
        .content-area {
            background: rgba(26, 26, 46, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 150, 255, 0.2);
            border-radius: 20px;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(0, 150, 255, 0.2),
                0 0 30px rgba(0, 150, 255, 0.1);
            overflow: hidden;
            position: relative;
        }
        
        .content-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(0, 150, 255, 0.2);
            background: rgba(0, 150, 255, 0.1);
            position: relative;
            z-index: 1;
        }
        
        .content-header h2 {
            color: #0096ff;
            margin-bottom: 0.75rem;
            font-family: 'Orbitron', monospace;
            font-size: 1.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-shadow: 0 0 10px rgba(0, 150, 255, 0.5);
        }
        
        .content-header p {
            color: #87ceeb;
            font-size: 1rem;
            font-weight: 300;
            letter-spacing: 1px;
        }
        
        .content-body {
            padding: 2rem;
            position: relative;
            z-index: 1;
        }
        
        .command-form {
            margin-bottom: 2.5rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: #00d4ff;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 0 8px #00d4ff;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 1px solid rgba(0, 212, 255, 0.4);
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'Rajdhani', sans-serif;
            background: rgba(0, 40, 80, 0.6);
            color: #87ceeb;
            backdrop-filter: blur(10px);
            transition: all 0.4s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 
                0 0 20px rgba(0, 212, 255, 0.4),
                inset 0 0 20px rgba(0, 212, 255, 0.1);
            color: #00d4ff;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(135, 206, 235, 0.7);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #0096ff 0%, #0066cc 100%);
            color: white;
            border: 1px solid rgba(0, 150, 255, 0.3);
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            position: relative;
            overflow: hidden;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0, 150, 255, 0.4);
            background: linear-gradient(135deg, #00a8ff 0%, #0077dd 100%);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .terminal-container {
            margin-top: 3rem;
        }
        
        .terminal {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(0, 212, 255, 0.5);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 
                0 0 40px rgba(0, 212, 255, 0.3),
                inset 0 0 40px rgba(0, 212, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .terminal-header {
            background: rgba(0, 40, 80, 0.8);
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #00d4ff;
            font-size: 1rem;
            font-weight: 600;
            font-family: 'Orbitron', monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(0, 212, 255, 0.3);
        }

        .terminal-header i {
            text-shadow: 0 0 10px #00d4ff;
        }
        
        .terminal-body {
            padding: 2rem;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 1rem;
            line-height: 1.8;
            color: #00ff41;
            background: rgba(0, 0, 0, 0.95);
            min-height: 350px;
            max-height: 600px;
            overflow-y: auto;
            position: relative;
        }

        .terminal-body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 1px,
                    rgba(0, 255, 65, 0.03) 1px,
                    rgba(0, 255, 65, 0.03) 2px
                );
            pointer-events: none;
        }
        
        .command-prompt {
            color: #00d4ff;
            margin-bottom: 0.75rem;
            font-weight: bold;
            text-shadow: 0 0 8px #00d4ff;
        }
        
        .output-text {
            color: #00ff41;
            white-space: pre-wrap;
            word-wrap: break-word;
            text-shadow: 0 0 5px rgba(0, 255, 65, 0.3);
        }
        
        .error-text {
            color: #ff4444;
            text-shadow: 0 0 8px rgba(255, 68, 68, 0.5);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 50%;
            border-top-color: #00d4ff;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Holographic loading effect */
        .hologram-loader {
            display: inline-block;
            position: relative;
            width: 20px;
            height: 20px;
        }

        .hologram-loader::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px solid transparent;
            border-top: 2px solid #00d4ff;
            border-radius: 50%;
            animation: holoSpin 1s linear infinite;
        }

        .hologram-loader::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            border: 1px solid transparent;
            border-bottom: 1px solid #87ceeb;
            border-radius: 50%;
            animation: holoSpin 0.8s linear infinite reverse;
        }

        @keyframes holoSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .status-badge.success {
            background: rgba(34, 197, 94, 0.1);
            color: #059669;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .status-badge.error {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .status-badge.loading {
            background: rgba(59, 130, 246, 0.1);
            color: #2563eb;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 300px 1fr;
                gap: 2rem;
            }
        }

        @media (max-width: 968px) {
            .main-container {
                grid-template-columns: 1fr;
                gap: 2rem;
                padding: 0 1rem;
            }
            
            .sidebar {
                position: static;
                order: 2;
            }

            .content-area {
                order: 1;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                padding: 0 1rem;
                flex-direction: column;
                gap: 1rem;
            }
            
            .nav-menu {
                gap: 1.5rem;
                font-size: 1rem;
            }

            .nav-menu a {
                padding: 0.4rem 0.8rem;
            }

            .logo {
                font-size: 1.8rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .container {
                padding: 15px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
                letter-spacing: 1px;
            }

            .nav-menu {
                gap: 1rem;
                flex-wrap: wrap;
                justify-content: center;
            }

            .nav-menu a {
                font-size: 0.9rem;
            }

            .btn-primary {
                padding: 0.8rem 1.5rem;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div id="nav-placeholder"></div>

    <div class="main-container" style="grid-template-columns: 1fr; max-width: 1600px;">
        <main class="content-area">
            <div class="content-header">
                <h2>
                    <i class="fas fa-server"></i>
                    Server Services
                </h2>
                <p>View all available game server services</p>
            </div>
            
            <div class="content-body">
                <div style="display: flex; gap: 1rem; margin-bottom: 2rem; align-items: center; flex-wrap: wrap;">
                    <button type="button" class="btn-primary" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                    <button type="button" class="btn-primary" id="getServicesBtn">
                        <i class="fas fa-list"></i>
                        Get Services
                    </button>
                    <button type="button" class="btn-primary" id="getStatsBtn">
                        <i class="fas fa-chart-bar"></i>
                        Get Stats
                    </button>
                    <span id="loadingStatus" style="color: #87ceeb; font-size: 0.9rem;"></span>
                </div>

                <!-- Applications List -->
                <div id="applicationsContainer" style="margin-bottom: 2rem;">
                    <h3 style="color: #0096ff; margin-bottom: 1rem; font-size: 1.3rem; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-th-large"></i>
                        Available Applications
                    </h3>
                    <div id="applicationsList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">
                        <!-- Applications will be inserted here -->
                        <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #666;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                            <p>Loading applications...</p>
                        </div>
                    </div>
                </div>

                <div id="servicesContainer" style="margin-bottom: 2rem;">
                    <!-- Services table will be inserted here -->
                </div>

                <div class="terminal-container">
                    <div class="terminal">
                        <div class="terminal-header">
                            <i class="fas fa-microchip"></i>
                            System Output
                        </div>
                        <div class="terminal-body" id="terminalOutput">
                            <div class="output-text">Ready. Click "Get Services" to retrieve server information...</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const terminalOutput = document.getElementById('terminalOutput');
        const servicesContainer = document.getElementById('servicesContainer');
        const loadingStatus = document.getElementById('loadingStatus');
        const refreshBtn = document.getElementById('refreshBtn');

        let servicesData = [];

        function addTerminalLine(text, type = 'output') {
            const line = document.createElement('div');
            line.className = `output-text ${type}`;
            line.textContent = text;
            terminalOutput.appendChild(line);
            terminalOutput.scrollTop = terminalOutput.scrollHeight;
        }

        function clearTerminal() {
            terminalOutput.innerHTML = '';
        }

        function setLoadingStatus(message) {
            loadingStatus.textContent = message;
        }

        async function fetchServices() {
            try {
                const response = await fetch('/get-services', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                console.log('Get Services Result:', result);
                
                if (result.success) {
                    // Check if services array exists
                    if (result.services && Array.isArray(result.services)) {
                        // Backend returns: [{name: "service", application: "App", path: "/path"}, ...]
                        return result.services;
                    }
                    
                    // If no services array, try to parse the output
                    if (result.output) {
                        try {
                            const parsed = JSON.parse(result.output.trim());
                            // If it's an object with service data
                            if (typeof parsed === 'object' && !Array.isArray(parsed)) {
                                // Extract all services from the object
                                const services = [];
                                Object.keys(parsed).forEach(serviceName => {
                                    const serviceData = parsed[serviceName];
                                    services.push({
                                        name: serviceName,
                                        application: result.applications?.[0]?.name || 'Unknown',
                                        path: result.applications?.[0]?.path || '',
                                        statsData: serviceData // Include the full service data
                                    });
                                });
                                return services;
                            }
                        } catch (e) {
                            console.error('Error parsing services output:', e);
                        }
                    }
                }
                
                addTerminalLine('Failed to get services: ' + (result.error || 'Unknown error'), 'error');
                return [];
            } catch (error) {
                console.error('Error fetching services:', error);
                addTerminalLine('Network error fetching services: ' + error.message, 'error');
                return [];
            }
        }

        async function fetchStatsForService(serviceName) {
            try {
                const response = await fetch('/get-stats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ service: serviceName })
                });

                const result = await response.json();
                
                if (result.success && result.output) {
                    // Parse the JSON stats output
                    try {
                        const statsJson = JSON.parse(result.output.trim());
                        // The stats JSON contains ALL services from the application
                        // Format: {"service-name": {...stats...}, "service-name-2": {...stats...}}
                        
                        return {
                            serviceName: serviceName,
                            stats: result.output,
                            statsData: statsJson, // Return entire stats object
                            success: true
                        };
                    } catch (e) {
                        console.error('Error parsing stats JSON for ' + serviceName + ':', e);
                        return {
                            serviceName: serviceName,
                            stats: result.output,
                            statsData: null,
                            success: false
                        };
                    }
                } else {
                    return {
                        serviceName: serviceName,
                        stats: result.error || 'Failed to get stats',
                        statsData: null,
                        success: false
                    };
                }
            } catch (error) {
                console.error('Error fetching stats for ' + serviceName + ':', error);
                return {
                    serviceName: serviceName,
                    stats: 'Network error: ' + error.message,
                    statsData: null,
                    success: false
                };
            }
        }

        function createServicesTable(servicesWithStats) {
            console.log('Creating table with services:', servicesWithStats);
            
            if (servicesWithStats.length === 0) {
                servicesContainer.innerHTML = '<p style="color: #87ceeb; text-align: center; padding: 2rem;">No services found.</p>';
                return;
            }

            let tableHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: rgba(0, 40, 80, 0.3); border: 1px solid rgba(0, 150, 255, 0.2); border-radius: 10px; overflow: hidden;">
                        <thead>
                            <tr style="background: rgba(0, 150, 255, 0.2); border-bottom: 2px solid rgba(0, 150, 255, 0.4);">
                                <th style="padding: 1rem; text-align: left; color: #00d4ff; font-weight: 600; text-transform: uppercase; font-size: 0.9rem;">Service</th>
                                <th style="padding: 1rem; text-align: left; color: #00d4ff; font-weight: 600; text-transform: uppercase; font-size: 0.9rem;">Server Name</th>
                                <th style="padding: 1rem; text-align: center; color: #00d4ff; font-weight: 600; text-transform: uppercase; font-size: 0.9rem;">Status</th>
                                <th style="padding: 1rem; text-align: center; color: #00d4ff; font-weight: 600; text-transform: uppercase; font-size: 0.9rem;">Port</th>
                                <th style="padding: 1rem; text-align: center; color: #00d4ff; font-weight: 600; text-transform: uppercase; font-size: 0.9rem;">Players</th>
                                <th style="padding: 1rem; text-align: center; color: #00d4ff; font-weight: 600; text-transform: uppercase; font-size: 0.9rem;">Memory</th>
                                <th style="padding: 1rem; text-align: center; color: #00d4ff; font-weight: 600; text-transform: uppercase; font-size: 0.9rem;">CPU</th>
                                <th style="padding: 1rem; text-align: center; color: #00d4ff; font-weight: 600; text-transform: uppercase; font-size: 0.9rem;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            servicesWithStats.forEach((service, index) => {
                console.log(`Processing service ${index}:`, service);
                
                const bgColor = index % 2 === 0 ? 'rgba(0, 40, 80, 0.2)' : 'rgba(0, 40, 80, 0.4)';
                const serviceName = service.serviceName || service.name;
                const appName = service.application || 'Unknown';
                
                // Parse the stats data
                let parsedStats = null;
                let statusColor = '#ef4444';
                let statusIcon = 'fa-exclamation-circle';
                let statusText = 'ERROR';
                let serviceStatus = 'unknown';
                let serviceId = serviceName; // service ID like "ark-extinction"
                let serverName = serviceName; // Server name like "We Like Big booty latinas (Extinction)"
                let port = '-';
                let players = '-';
                let memory = '-';
                let cpu = '-';
                
                // Check if we have statsData
                if (service.statsData) {
                    parsedStats = service.statsData;
                    serviceStatus = parsedStats.status || 'unknown';
                    statusColor = serviceStatus === 'running' ? '#22c55e' : '#ef4444';
                    statusIcon = serviceStatus === 'running' ? 'fa-check-circle' : 'fa-times-circle';
                    statusText = serviceStatus.toUpperCase();
                    
                    // Extract data from stats
                    serviceId = parsedStats.service || serviceName; // The service ID
                    serverName = parsedStats.name || serviceName; // The display name
                    port = parsedStats.port || '-';
                    players = parsedStats.player_count !== null && parsedStats.player_count !== undefined 
                        ? `${parsedStats.player_count}/${parsedStats.max_players}` 
                        : '-';
                    memory = parsedStats.memory_usage || '-';
                    cpu = parsedStats.cpu_usage || '-';
                    
                    console.log(`Service ${serviceName} stats:`, parsedStats);
                } else {
                    console.warn(`Service ${serviceName} has no statsData`);
                }

                // Determine which buttons to show based on status
                const isRunning = serviceStatus === 'running';
                const isStopped = serviceStatus === 'stopped' || serviceStatus === 'offline';
                const isRestarting = serviceStatus === 'restarting';
                
                // Build action buttons based on status
                let actionButtons = '';
                
                // Show Start button only if NOT running
                if (!isRunning) {
                    actionButtons += `
                        <button onclick="serviceAction('${serviceName}', 'start')" 
                            style="padding: 0.4rem 0.8rem; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); border: none; border-radius: 5px; color: white; cursor: pointer; font-weight: 500; font-size: 0.85rem; transition: all 0.3s; box-shadow: 0 2px 4px rgba(34, 197, 94, 0.3);"
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(34, 197, 94, 0.4)';"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(34, 197, 94, 0.3)';">
                            <i class="fas fa-play"></i> Start
                        </button>
                    `;
                }
                
                // Show Stop button only if NOT stopped/offline
                if (!isStopped) {
                    actionButtons += `
                        <button onclick="serviceAction('${serviceName}', 'stop')" 
                            style="padding: 0.4rem 0.8rem; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border: none; border-radius: 5px; color: white; cursor: pointer; font-weight: 500; font-size: 0.85rem; transition: all 0.3s; box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);"
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(239, 68, 68, 0.4)';"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(239, 68, 68, 0.3)';">
                            <i class="fas fa-stop"></i> Stop
                        </button>
                    `;
                }
                
                // Show Restart button only if NOT already restarting
                if (!isRestarting) {
                    actionButtons += `
                        <button onclick="serviceAction('${serviceName}', 'restart')" 
                            style="padding: 0.4rem 0.8rem; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border: none; border-radius: 5px; color: white; cursor: pointer; font-weight: 500; font-size: 0.85rem; transition: all 0.3s; box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);"
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(245, 158, 11, 0.4)';"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(245, 158, 11, 0.3)';">
                            <i class="fas fa-sync-alt"></i> Restart
                        </button>
                    `;
                }

                tableHTML += `
                    <tr style="background: ${bgColor}; border-bottom: 1px solid rgba(0, 150, 255, 0.1); transition: background 0.3s;">
                        <td style="padding: 1rem; color: #00d4ff; font-family: 'Monaco', monospace; font-size: 0.85rem;">${serviceId}</td>
                        <td style="padding: 1rem; color: #87ceeb; font-weight: 500;">${serverName}</td>
                        <td style="padding: 1rem; text-align: center;">
                            <span style="display: inline-flex; align-items: center; gap: 0.5rem; color: ${statusColor}; font-weight: 600;">
                                <i class="fas ${statusIcon}"></i>
                                ${statusText}
                            </span>
                        </td>
                        <td style="padding: 1rem; text-align: center; color: #e2e8f0; font-family: 'Monaco', monospace; font-size: 0.9rem;">${port}</td>
                        <td style="padding: 1rem; text-align: center; color: #e2e8f0;">${players}</td>
                        <td style="padding: 1rem; text-align: center; color: #e2e8f0;">${memory}</td>
                        <td style="padding: 1rem; text-align: center; color: #e2e8f0;">${cpu}</td>
                        <td style="padding: 1rem; text-align: center;">
                            <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                                ${actionButtons}
                            </div>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            servicesContainer.innerHTML = tableHTML;
        }

        async function loadAllServicesAndStats() {
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            clearTerminal();
            addTerminalLine('> Loading services and stats...', 'command');
            
            setLoadingStatus('Fetching services...');

            // Step 1: Get all services
            const services = await fetchServices();
            
            console.log('Fetched services:', services);
            
            if (services.length === 0) {
                setLoadingStatus('No services found');
                servicesContainer.innerHTML = '<p style="color: #87ceeb; text-align: center; padding: 2rem;">No services available.</p>';
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                addTerminalLine('No services found', 'error');
                return;
            }

            addTerminalLine(`Found ${services.length} service(s)`, 'success');

            // Step 2: Check if services already have data embedded
            let servicesWithStats = services.map(service => {
                // Check if service has the full data fields
                if (service.service || service.serverName || service.status) {
                    // Service has full data from --get-services
                    return {
                        serviceName: service.name,
                        name: service.name,
                        application: service.application,
                        path: service.path,
                        statsData: {
                            service: service.service || service.name,
                            name: service.serverName || service.name,
                            ip: service.ip,
                            port: service.port,
                            status: service.status,
                            player_count: service.player_count,
                            max_players: service.max_players,
                            memory_usage: service.memory_usage,
                            cpu_usage: service.cpu_usage,
                            game_pid: service.game_pid,
                            service_pid: service.service_pid
                        },
                        success: true
                    };
                } else {
                    // Service only has name, no stats
                    return {
                        serviceName: service.name,
                        name: service.name,
                        application: service.application,
                        path: service.path,
                        statsData: null,
                        success: false
                    };
                }
            });

            // Step 3: Create and display the table
            console.log('Final servicesWithStats:', servicesWithStats);
            console.log(`Total services to display: ${servicesWithStats.length}`);
            
            createServicesTable(servicesWithStats);
            servicesData = servicesWithStats;

            setLoadingStatus('');
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
            addTerminalLine('All services and stats loaded successfully', 'success');
        }

        async function manualGetServices() {
            clearTerminal();
            addTerminalLine('> Executing: ./manage.py --get-services', 'command');
            addTerminalLine('Connecting to remote server...', 'info');
            
            const btn = document.getElementById('getServicesBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running...';

            try {
                const response = await fetch('/get-services', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                console.log('Get Services Result:', result);
                
                if (result.success) {
                    addTerminalLine('Command executed successfully:', 'success');
                    addTerminalLine('');
                    
                    // Split output by lines and display each
                    const outputLines = result.output.split('\n');
                    outputLines.forEach(line => {
                        if (line.trim()) {
                            addTerminalLine(line);
                        }
                    });
                    
                    if (result.stderr) {
                        addTerminalLine('');
                        addTerminalLine('Warnings/Errors:', 'warning');
                        result.stderr.split('\n').forEach(line => {
                            if (line.trim()) {
                                addTerminalLine(line, 'error');
                            }
                        });
                    }
                } else {
                    addTerminalLine('Command failed:', 'error');
                    addTerminalLine(result.error || 'Unknown error', 'error');
                    if (result.output) {
                        addTerminalLine('');
                        addTerminalLine('Output:', 'warning');
                        addTerminalLine(result.output);
                    }
                }
            } catch (error) {
                console.error('Network error:', error);
                addTerminalLine('Network error: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-list"></i> Get Services';
            }
        }

        async function manualGetStats() {
            clearTerminal();
            addTerminalLine('> Executing: ./manage.py --get-stats', 'command');
            addTerminalLine('Connecting to remote server...', 'info');
            
            const btn = document.getElementById('getStatsBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running...';

            try {
                const response = await fetch('/get-stats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                console.log('Get Stats Result:', result);
                
                if (result.success) {
                    addTerminalLine('Command executed successfully:', 'success');
                    addTerminalLine('');
                    
                    // Split output by lines and display each
                    const outputLines = result.output.split('\n');
                    outputLines.forEach(line => {
                        if (line.trim()) {
                            addTerminalLine(line);
                        }
                    });
                    
                    if (result.stderr) {
                        addTerminalLine('');
                        addTerminalLine('Warnings/Errors:', 'warning');
                        result.stderr.split('\n').forEach(line => {
                            if (line.trim()) {
                                addTerminalLine(line, 'error');
                            }
                        });
                    }
                } else {
                    addTerminalLine('Command failed:', 'error');
                    addTerminalLine(result.error || 'Unknown error', 'error');
                    if (result.output) {
                        addTerminalLine('');
                        addTerminalLine('Output:', 'warning');
                        addTerminalLine(result.output);
                    }
                }
            } catch (error) {
                console.error('Network error:', error);
                addTerminalLine('Network error: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-chart-bar"></i> Get Stats';
            }
        }

        async function serviceAction(serviceName, action) {
            addTerminalLine(`> Executing: ./manage.py --${action} --service ${serviceName}`, 'command');
            addTerminalLine('Connecting to remote server...', 'info');
            
            try {
                const response = await fetch('/service-action', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        service: serviceName,
                        action: action
                    })
                });

                const result = await response.json();
                
                console.log(`${action} result for ${serviceName}:`, result);
                
                if (result.success) {
                    addTerminalLine(`✓ ${action.toUpperCase()} command executed successfully for ${serviceName}`, 'success');
                    
                    if (result.output) {
                        const outputLines = result.output.split('\n');
                        outputLines.forEach(line => {
                            if (line.trim()) {
                                addTerminalLine(line);
                            }
                        });
                    }
                    
                    // Reload the services and stats after action
                    setTimeout(() => {
                        addTerminalLine('Refreshing service status...', 'info');
                        loadAllServicesAndStats();
                    }, 2000);
                } else {
                    addTerminalLine(`✗ ${action.toUpperCase()} command failed for ${serviceName}:`, 'error');
                    addTerminalLine(result.error || 'Unknown error', 'error');
                    if (result.output) {
                        addTerminalLine(result.output);
                    }
                }
            } catch (error) {
                console.error(`Network error during ${action}:`, error);
                addTerminalLine(`Network error: ${error.message}`, 'error');
            }
        }

        async function fetchApplications() {
            try {
                const response = await fetch('/get-applications', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                console.log('Applications Result:', result);
                
                if (result.success && result.applications) {
                    displayApplications(result.applications);
                    return result.applications;
                } else {
                    displayApplications([]);
                    return [];
                }
            } catch (error) {
                console.error('Error fetching applications:', error);
                displayApplications([]);
                return [];
            }
        }

        function displayApplications(applications) {
            const applicationsList = document.getElementById('applicationsList');
            
            if (applications.length === 0) {
                applicationsList.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #666;">
                        <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 1rem; display: block; opacity: 0.3;"></i>
                        <p>No applications found in /var/lib/warlock</p>
                    </div>
                `;
                return;
            }

            let html = '';
            applications.forEach(app => {
                // Extract the last folder name from the path
                const pathParts = app.path.split('/').filter(part => part.length > 0);
                const displayName = pathParts.length > 0 ? pathParts[pathParts.length - 1] : app.name;
                
                html += `
                    <div class="application-card" style="background: rgba(26, 26, 46, 0.9); border: 1px solid rgba(0, 150, 255, 0.2); border-radius: 12px; padding: 1.5rem; transition: all 0.3s; cursor: pointer; position: relative; overflow: hidden;"
                         onmouseover="this.style.borderColor='#0096ff'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(0, 150, 255, 0.3)';"
                         onmouseout="this.style.borderColor='rgba(0, 150, 255, 0.2)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                         onclick="window.open('/files.html?path=${encodeURIComponent(app.path)}', '_blank')">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #0096ff 0%, #0066cc 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0, 150, 255, 0.3);">
                                <i class="fas fa-cube" style="font-size: 1.5rem; color: white;"></i>
                            </div>
                            <div style="flex: 1;">
                                <h4 style="color: #0096ff; margin: 0; font-size: 1.1rem; font-weight: 600;">${displayName}</h4>
                            </div>
                        </div>
                        <div style="padding: 0.75rem; background: rgba(0, 40, 80, 0.4); border-radius: 6px; border-left: 3px solid #0096ff;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; color: #87ceeb; font-size: 0.9rem;">
                                <i class="fas fa-folder" style="color: #0096ff;"></i>
                                <span style="font-family: 'Monaco', monospace; word-break: break-all;">${app.path}</span>
                            </div>
                        </div>
                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                            <button onclick="event.stopPropagation(); window.open('/files.html?path=${encodeURIComponent(app.path)}', '_blank')" 
                                    style="flex: 1; padding: 0.5rem; background: linear-gradient(135deg, #0096ff 0%, #0066cc 100%); border: none; border-radius: 6px; color: white; font-size: 0.85rem; cursor: pointer; transition: all 0.3s;"
                                    onmouseover="this.style.background='linear-gradient(135deg, #00a8ff 0%, #0077dd 100%)'"
                                    onmouseout="this.style.background='linear-gradient(135deg, #0096ff 0%, #0066cc 100%)'">
                                <i class="fas fa-folder-open"></i> Browse
                            </button>
                        </div>
                    </div>
                `;
            });

            applicationsList.innerHTML = html;
        }

        // Event listeners
        refreshBtn.addEventListener('click', loadAllServicesAndStats);
        document.getElementById('getServicesBtn').addEventListener('click', manualGetServices);
        document.getElementById('getStatsBtn').addEventListener('click', manualGetStats);

        // Load navigation component
        fetch('/components/nav')
            .then(response => response.text())
            .then(html => {
                document.getElementById('nav-placeholder').innerHTML = html;
            })
            .catch(error => console.error('Error loading navigation:', error));

        // Load on page load
        window.addEventListener('DOMContentLoaded', () => {
            addTerminalLine('Dashboard loaded. Fetching applications and services...', 'info');
            fetchApplications();
            loadAllServicesAndStats();
            
            // Auto-refresh every 5 seconds
            setInterval(() => {
                addTerminalLine('Auto-refreshing...', 'info');
                loadAllServicesAndStats();
            }, 5000);
        });
    </script>
</body>
</html>
```